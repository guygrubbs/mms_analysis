# Diagnostics and CI Guide

This document explains the spectrogram diagnostics outputs, UTC policy, CI setup, and CLI helpers.

## Spectrogram diagnostics

- Generated by `test_boundary_threshold_case.py` as `spectrogram_diagnostics.csv`.
- Columns:
  - `species`, `probe`, `candidate_or_dist_var`, `energy_var`, `energy_info`, `status`, `t_start_UT`, `t_end_UT`, `n_times`
- Status values include:
  - `CANDIDATE_COVERAGE`: tplot omni candidate discovered, with UT coverage
  - `OMNI_COVERAGE`: final omni spectrogram variable, with UT coverage
  - `DIST_COVERAGE`: fallback distribution variable coverage
  - `ENERGY_COVERAGE`: fallback energy variable coverage
  - `COVERAGE`: coverage for the plotted spectrogram (times used for plotting)
  - `OMNI_NO_ENERGY_VECTOR`: omni spectrogram lacked energy vector; bins imputed
  - `IMPUTED_ENERGY_VECTOR`: dist fallback constructed energy axis; bins logged
  - `MISSING_DIST_OR_ENERGY`: fallback variables missing
  - `NOT_FOUND`: no omni spectrogram candidates found

### Diagnostics pages in the PDF bundle
- A summary page counts statuses by species/probe.
- A detailed page shows a table of up to 30 rows, with ellipsis if truncated.

## UTC policy

- All time axes are UT (`plt.rcParams['timezone'] = 'UTC'`).
- `ensure_datetime_format(times)` normalizes time arrays to tz-aware UTC.
- CSV/JSON times are formatted as UT strings with `%Y-%m-%d %H:%M:%S`.
- A one-time log notes UTC normalization at runtime.

## CI setup

- GitHub Actions workflow `.github/workflows/ci.yml` runs tests on push/PR.
- It attempts to install dev extras (`.[dev]`), then falls back to `requirements*.txt`.
- Tests are executed with the repo's `pyproject.toml` pytest config (including timeouts).

## Local testing

- Install dev dependencies:
  - `python -m pip install -r requirements-dev.txt`
- Run the test suite:
  - `python -m pytest -q`

## Troubleshooting
- If spectrograms are missing for certain MMS/species, consult `spectrogram_diagnostics.csv` to see which variables were available and their UT coverage windows.
- For persistent missing energy vectors, validate local FPI energy tplot variables or rely on the imputed energy vectors (logged in diagnostics).

