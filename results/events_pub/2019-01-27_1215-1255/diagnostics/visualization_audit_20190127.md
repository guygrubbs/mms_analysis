# MMS 2019-01-27 Event Visualization Audit

This document records the audit of all PNG/PDF visualizations under
`results/events_pub/2019-01-27_1215-1255/` as of 2025-12-01.

## 1. Inventory and generating scripts

### 1.1 `examples/make_event_figures_20190127.py`

Figures generated (per fresh run during this audit):

- `vn_overlay_mms1.png`–`vn_overlay_mms4.png`
- `vn_overlay_stack.png`
- `vn_diff_hist_mms1.png`–`vn_diff_hist_mms4.png`
- `vn_offset_hist_mms1.png`–`vn_offset_hist_mms4.png`
- `mms1_DN_segments.png`–`mms4_DN_segments.png`
- `mms1_DIS_omni.png`–`mms4_DIS_omni.png`
- `mms1_DES_omni.png`–`mms4_DES_omni.png`

These are written directly in `_plot_vin_overlay`, `_plot_diff_hist`,
`_plot_offset_hist`, `_stack_vin`, `_spectrograms`, and `_compute_dn`.

### 1.2 `examples/analyze_20190127_dn_shear.py`

Figures generated by this script (fresh run during this audit):

- `dn_vs_time_all_1243.png`
- `dn_vs_time_mixed_1230_1243.png`
- `bn_stacked_all_1243.png`
- `bn_stacked_mixed_1230_1243.png`
- `xline_3d_all_1243.png`
- `xline_3d_mixed_1230_1243.png`

These come from `plot_dn`, `plot_bn_stack`, and `shear_and_xline`.
The script also *can* generate `pred_vs_actual_{label}.png` and
`shear_angles_{label}.png`, but see §3.2 for why those PNGs were
removed as stale.

### 1.3 `examples/diagnostic_sav_vs_mmsmp_20190127.py`

Figures generated in `results/.../diagnostics/` (fresh run):

- `bn_overlay_mms1.png`–`bn_overlay_mms4.png`
- `comparison_bl_direct_mms1.png`–`comparison_bl_direct_mms4.png`
- `comparison_bm_direct_mms1.png`–`comparison_bm_direct_mms4.png`
- `comparison_bn_direct_mms1.png`–`comparison_bn_direct_mms4.png`
- `vn_overlay_mms1.png`–`vn_overlay_mms4.png`
- `dn_overlay_mms1.png`–`dn_overlay_mms4.png`

These are produced by the BN, VN, and DN comparison helpers in the
script, alongside the consolidated statistics CSVs.

No PDFs are present; all visualizations are PNGs.

## 2. Time ranges used in figures

### 2.1 Canonical event window

All three scripts use the canonical event window
`TRANGE = ('2019-01-27/12:15:00', '2019-01-27/12:55:00')` for
published figures. Where a larger range is used for diagnostics or
numerics (e.g. `TRANGE_FULL` from the IDL .sav), plots are still
clipped to 12:15–12:55 unless explicitly noted.

### 2.2 `make_event_figures_20190127.py`

- VN overlays, difference histograms, offset histograms, and the
  stacked VN plot are all clipped internally to 12:15–12:55 UTC.
- DN-segment bar plots show DN integrated over vt intervals that lie
  inside this window.
- DIS/DES spectrograms use `trange=TRANGE` when calling
  `mp.spectra.generic_spectrogram`, so their time axes are also
  restricted to 12:15–12:55 UTC.

### 2.3 `analyze_20190127_dn_shear.py`

- `dn_vs_time_*` and `bn_stacked_*` use time series built from event
  data loaded over TRANGE, so effectively cover 12:15–12:55 UTC.
- `xline_3d_*` are static 3D formation snapshots at a single time
  (12:45 UTC) with no horizontal time axis; they are treated as
  scientifically justified subsets of the event.

### 2.4 `diagnostic_sav_vs_mmsmp_20190127.py`

- BN, VN, and DN overlays are constructed using the full
  `TRANGE_FULL` from the IDL .sav for statistics, but plots are
  clipped to the 12:15–12:55 event window for visual comparison.

## 3. Regeneration status and stale figures

### 3.1 Scripts re-run

During this audit the following scripts were executed successfully
(with only expected runtime warnings from NumPy and pySPEDAS):

- `examples/make_event_figures_20190127.py`
- `examples/analyze_20190127_dn_shear.py`
- `examples/diagnostic_sav_vs_mmsmp_20190127.py`

All three completed without errors and refreshed their respective
figures and CSV/JSON outputs.

### 3.2 Removed stale PNGs

The following PNGs were present but **not** regenerated by the current
code paths, because the corresponding dataframes are empty in the
latest run:

- `pred_vs_actual_all_1243.png`
- `pred_vs_actual_mixed_1230_1243.png`
- `shear_angles_all_1243.png`
- `shear_angles_mixed_1230_1243.png`

In the current pipeline:

- `crossings_and_predictions(...)` still produces `predictions_*.csv`,
  but the `pred_df` used to build `pred_vs_actual_*` plots is empty.
- `shear_and_xline(...)` returns an empty `shear_df`, so the
  `shear_angles_*` plots are not drawn, although the underlying
  (empty) `shear_*.csv` are still written.

Because these PNGs cannot be reproduced by the current code and would
misrepresent the present analysis, they were **deleted** as stale
outputs. The corresponding CSVs have been retained as they now reflect
empty or updated content from the latest run.

### 3.3 Spectrograms and DES limitations

For DIS/DES spectrograms, the audit confirms that:

- `mms{1-4}_DIS_omni.png` and `mms{1-4}_DES_omni.png` exist for all
  four probes.
- The spectrogram helper first attempts to use local CDFs via
  `cdflib` and `_collapse_fpi`, then falls back to
  `mp.data_loader.force_load_all_plasma_spectrometers` and
  `pyspedas.get_data` without any network downloads.
- For DES, local omni/flux variables are not available for some
  probes, so the helper may fall back to placeholders that explicitly
  state spectrogram unavailability.

These figures therefore honestly represent either the best-available
local spectrograms or clearly labelled placeholders and are considered
current for this audit.

## 4. Summary versus success criteria

- **All visualization-generating scripts now run without errors** and
  have been re-executed as part of this audit.
- **All VN, DN, BN comparison, and main event figures** now span the
  full 12:15–12:55 UTC event window, except for:
  - The 3D formation snapshots (`xline_3d_*`), which intentionally
    depict the configuration at 12:45 UTC.
- **Stale or unreproducible PNGs** (`pred_vs_actual_*`,
  `shear_angles_*`) have been removed; their underlying CSVs now
  reflect the latest run (currently with empty prediction/shear
  content).
- **Spectrogram figures** are up to date with the current
  spectrogram-loading logic and are either real DIS/DES spectrograms
  from local CDFs or explicit placeholders documenting DES
  limitations.

Open item (outside the scope of this visualization-only audit):
`tests/test_real_event_vin.py` still reports large discrepancies
between pipeline ViN and the IDL reference; those discrepancies are
numerically documented in the diagnostics CSVs and
`issues_and_resolutions.md` and will need a dedicated physics/LMN
alignment pass to resolve.

## 5. VN alignment experiment knobs (script interface)

For reproducible ViN alignment experiments without copying
`make_event_figures_20190127.py`, the script now exposes a small
set of command-line options:

- `--vn-alignment-method {nearest,linear,cubic}` controls how
  mms_mp ViN is aligned to the IDL `.sav` timestamps (nearest
  neighbour, linear interpolation, or cubic spline where SciPy is
  available).
- `--max-time-offset-ms FLOAT` optionally masks any IDL ViN sample
  whose nearest mms_mp ViN point is farther than the given absolute
  time offset in milliseconds; masked samples are excluded from the
  VN QA histograms and from `metrics.json`.
- `--vn-qa-window-start` / `--vn-qa-window-end` (both UTC strings
  like `2019-01-27/12:25:00`) restrict the time window used for VN
  QA overlays and histograms. If omitted, the canonical
  12:15–12:55 `TRANGE` is used.

The JSON file `results/events_pub/2019-01-27_1215-1255/metrics.json`
includes a `"config"` block recording the chosen
`vn_alignment_method` and `max_time_offset_ms` so that regenerated
VN figures and metrics remain self-describing.

