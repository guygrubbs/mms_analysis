# Issues and Correction Plan — MMS 2019-01-27 (12:15–12:55)

This note documents discrepancies found during validation of .sav-derived quantities against independently processed CDF data with strict local caching, and proposes next steps.

## Summary of findings (facts)

- LMN orientation: Hybrid LMN (from mms_mp) differs from curated .sav LMN by ~90° (N-angle) for MMS1–4 over the .sav intervals. BN differences are large (MAE≈350–400 nT, RMSE≈1.2–1.4 µT) but correlations are moderately positive (0.79–0.87), consistent with a rotated frame rather than random noise.
- VN (.sav ViN vs mms_mp V_i·N_sav): MAE≈22–27 km/s; RMSE≈30–37 km/s; correlations ~0 to machine epsilon. Likely explained by cadence/time-alignment and quality-flag masking differences between .sav ViN and Python-derived V_i.
- DN vs published all_1243 CSV: No overlapping valid samples within the event window 12:15–12:55. The published DN CSV (dn_mms*_all_1243.csv) contains non-empty values primarily after ~13:03–13:50 UT, outside this event window. Therefore, RMSE/MAE/corr relative to the published DN are undefined (NaN) for this TRANGE.

## Likely root causes

1) LMN orientation discrepancy (~90°)
- Sensitivity of MVA/hybrid methods to interval selection and criteria; the .sav triads reflect expert-curated boundary intervals specific to this event, while the independent hybrid derivation selects a different effective orientation.

2) VN decorrelation
- Timebase alignment: Without forcing both series onto a shared grid and nearest-neighbor interpolation, small offsets erase correlation. After gridding, correlation still ~0, suggesting different filtering/quality masks.
- Quality flags: .sav may apply DIS quality flag masking or smoothing steps that differ from straight re-sampling of FPI fast moments.

3) DN comparison NaNs
- The published DN file’s valid windows do not intersect the requested 12:15–12:55 TRANGE (values mostly after 13:03 UT). Our diagnostics correctly return no overlap.

## DN metrics policy (resolved)

- DN metrics are now defined **only** for DN(mms_mp) vs DN(.sav-windowed), using the same cold-ion windows inferred from `mms*_DN_segments.csv` and restricted to the **12:15–12:55 UT** window.
- The published DN (`dn_mms*_all_1243.csv`) is treated as a **documentation-only artifact** in this context, since its non-NaN content occurs mostly after ~13:03 UT and does not overlap the diagnostic window.
- This policy follows **Option B** from the decision log and is implemented in `examples/diagnostic_sav_vs_mmsmp_20190127.py` and documented in `diagnostic_comparison.md`.

## Corrections recommended (minimal, scoped)

P1. Treat .sav LMN as authoritative for this event (as already documented). Keep independent hybrid LMN in diagnostics only.

P2. VN alignment and masking
- Ensure VN_mms uses the same DIS quality policy as the .sav workflow. Recommendation:
  - Accept DIS quality 0; optionally allow 1 for MMS4 as per mission-era conventions.
  - Drop samples with density/velocity NaNs before resampling.
- Keep both VN series on a shared 1 s UTC grid using nearest interpolation with a 0.5 s tolerance.

P3. DN metrics vs published
- For this event window (12:15–12:55), compare DN(mms_mp) vs DN(sav) integrated over the same cold-ion windows from mms*_DN_segments.csv.
- Separately, if comparison to dn_mms*_all_1243.csv is required, expand TRANGE to 12:00–13:55 for diagnostics or subset the published DN to the 12:15–12:55 window only (will produce no-overlap, which is honest and expected with the current CSV content).

## Optional follow-ups (deeper work)
- Implement a robust interval finder that reproduces .sav LMN by matching the curated intervals, then recompute hybrid_lmn() inside those exact spans.
- Add a sliding lag-correlation scan for VN to detect and quantify any residual time offset (±10 s) between series.
- Add explicit DIS/DES quality-flag masking parity layer to match the .sav processing pipeline.

## Status
- Diagnostics updated and saved to results/events_pub/2019-01-27_1215-1255/diagnostics/.
- No changes to the primary analysis outputs; publication results continue to use .sav LMN for this event.

## Request for guidance
- Do you want me to (a) expand the diagnostic TRANGE to include 13:03–13:50 to compute DN metrics vs the published all_1243 file, or (b) keep the diagnostics strictly within 12:15–12:55 and instead compute DN metrics vs the .sav-integrated DN (windowed) only?

